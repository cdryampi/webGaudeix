<!-- HTML -->
{% load i18n %}
<aside class="container-fluid m-0 p-0 py-3" style="background-color: #FFB516;">
  <div class="row justify-content-center m-0 p-0">
    <div class="col-lg-6">
      <form id="newsletter-form" class="text-center">
        {% csrf_token %}
        <div class="form-group justify-content-center px-5">
          <h2 class="text-center my-4 text-white bold">{% blocktrans %}Butlletí electrònic{% endblocktrans %}</h2>
          
            <div class="col-12">
              <div class="row justify-content-center">
                <div class="input-group text-center w-lg-50 w-sm-75 w-md-75 w-100">
                  <input type="email" class="form-control form-control-lg w-25" id="emailNewsletter" placeholder="{% blocktrans %}Introduïu el vostre correu electrònic{% endblocktrans %}" required>
                <div class="input-group-append">
                  <button class="btn btn-primary" type="submit"><i class="fas fa-arrow-right"></i></button>
                </div>
                </div>
              </div>

          </div>
        </div>
      </form>
      
    </div>
  </div>
    <!-- Ventana modal para notificaciones -->
  <div class="modal fade" id="notificacionEmailModal" tabindex="-1" role="dialog" aria-labelledby="notificacionEmailModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="notificacionEmailModalLabel">{% blocktrans %}Notificació{% endblocktrans %}:</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div id="notification-messages" class="text-center mt-3"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">{% blocktrans %}tancar{% endblocktrans %}</button>
        </div>
      </div>
    </div>
  </div>

</aside>
  
  <script>
    // JavaScript
    document.getElementById('newsletter-form').addEventListener('submit', function(event) {
      event.preventDefault();

      const notificacionEmailModal = document.getElementById("notificacionEmailModal");

      var emailInput = document.getElementById('emailNewsletter');
      
      var email = emailInput.value;
      

      // Validar el correo electrónico
      if (!validateEmail(email)) {
        displayNotification('error', 'Direcció de correu electrònic invàlida');
        return;
      }
  
      // Obtener el token CSRF del formulario
      var csrfToken = document.querySelector("#newsletter-form input[name='csrfmiddlewaretoken']").value
  
      // Crear un objeto FormData y agregar el correo electrónico
      var formData = new FormData();
      formData.append('email', email);
  
      // Realizar la petición al servidor utilizando fetch
      fetch('/api/newsletter/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken
        },
        body: formData
      })
      .then(function(response) {
        if (response.ok) {
          return response.json();
        } else {
          throw new Error('Error en la petició');
        }
      })
      .then(function(data) {
        if (data.success) {
          updateAndShowModal('Subscripció exitosa');
        } else {
          updateAndShowModal('Error en la petició');
        }
      })
      .catch(function(error) {
        updateAndShowModal(error.message);
      });
  
      // Limpiar el campo de correo electrónico
      emailInput.value = '';
    });
  
    function validateEmail(email) {
      // Validar el formato del correo electrónico
      var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    function updateAndShowModal(message) {
      var modalBody = document.querySelector('#notificacionEmailModal .modal-body #notification-messages');
      modalBody.innerText = message;
      console.log(message);
      $('#notificacionEmailModal').modal('show');
    }

  </script>
  